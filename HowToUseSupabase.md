# How to Use Supabase in CalmCampus

A practical reference for wiring Supabase into the CalmCampus Flutter app (auth, database, storage, and realtime). Keep keys out of source control and use environment-specific configs.

## Prerequisites
- Supabase account + project (pick a region close to your users)
- Flutter/Dart toolchain installed
- Node.js + `supabase` CLI (optional but recommended for local DB/testing): `npm install -g supabase`
- Expo/Android/iOS emulators or a device for testing auth flows

## Project Keys & Environment Setup
1) In the Supabase dashboard, copy your **Project URL** and **anon/public API key**. Keep the **service role key** for server-only scripts (never ship it in the app).
2) Add Dart defines for each build flavor (dev/prod). Example `env/dev.json`:
```json
{
  "SUPABASE_URL": "https://your-project.supabase.co",
  "SUPABASE_ANON_KEY": "paste_anon_key_here"
}
```
Run with: `flutter run --dart-define-from-file=env/dev.json`
3) Initialize in `main.dart` before `runApp`:
```dart
import 'package:supabase_flutter/supabase_flutter.dart';

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();
  await Supabase.initialize(
    url: const String.fromEnvironment('SUPABASE_URL'),
    anonKey: const String.fromEnvironment('SUPABASE_ANON_KEY'),
  );
  runApp(const MyApp());
}
```

## Adding the Dependency
```
dart pub add supabase_flutter
```
If you need only REST (no realtime/auth widgets), you can use `supabase` instead, but `supabase_flutter` keeps sessions fresh automatically.

## Auth Flows (Email/Password, Magic Link)
- **Sign up** (with email confirm):
```dart
final res = await Supabase.instance.client.auth.signUp(
  email: email,
  password: password,
  emailRedirectTo: 'https://luba-irrecusable-clayton.ngrok-free.dev', // update per environment
);
```
- **Sign in**:
```dart
await Supabase.instance.client.auth.signInWithPassword(
  email: email,
  password: password,
);
```
- **Magic link / passwordless**:
```dart
await Supabase.instance.client.auth.signInWithOtp(
  email: email,
  emailRedirectTo: 'https://luba-irrecusable-clayton.ngrok-free.dev',
);
```
- **Reset password**: trigger `resetPasswordForEmail`, handle redirect via `supabase.auth.onAuthStateChange` to show a change-password form.
- **Session refresh**: `supabase.auth.refreshSession()` (usually automatic in `supabase_flutter`).
- **Logout**: `supabase.auth.signOut();`

### Email Confirmation Tips
- In **Authentication > Providers**, set the Site URL to your redirect (e.g., the ngrok URL or your hosted domain).
- If users sign up but have not confirmed, prompt them to check email before retrying (prevents the stuck-signup bug noted in task.md).

## Database Basics
Use **Table Editor** or run SQL in **SQL Editor**.

Example tables for CalmCampus:
```sql
-- Profiles (minimal)
create table if not exists profiles (
  id uuid primary key references auth.users on delete cascade,
  nickname text,
  course text,
  year_of_study int,
  created_at timestamp with time zone default now()
);

-- Announcements
create table if not exists announcements (
  id bigint generated by default as identity primary key,
  title text not null,
  body text not null,
  created_at timestamp with time zone default now(),
  author text
);

-- Optional: moods and timetable if syncing cloud-side
create table if not exists moods (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users on delete cascade,
  mood text,
  main_theme text,
  note text,
  created_at timestamp with time zone default now()
);

create table if not exists classes (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users on delete cascade,
  subject text,
  day_of_week text,
  start_time text,
  end_time text,
  lecturer text,
  created_at timestamp with time zone default now()
);
```

### Row Level Security (RLS)
Turn on RLS per table, then add policies:
```sql
-- Profiles: each user manages their row
create policy "Users manage their profile" on profiles
for select using (auth.uid() = id)
with check (auth.uid() = id);

-- Moods/Classes: user owns their data
create policy "User can CRUD own moods" on moods
for all using (auth.uid() = user_id) with check (auth.uid() = user_id);
create policy "User can CRUD own classes" on classes
for all using (auth.uid() = user_id) with check (auth.uid() = user_id);

-- Announcements: read for all, write for service role only
create policy "Anyone can read announcements" on announcements for select using (true);
-- (For writes, call with service role key from your backend or admin script.)
```

### Flutter Data Access Examples
```dart
final supabase = Supabase.instance.client;

// Read announcements
totalAnnouncements() async {
  final res = await supabase.from('announcements').select().order('created_at', ascending: false);
  return res;
}

// Insert mood
taskInsertMood({required String mood, required String mainTheme, String? note}) async {
  await supabase.from('moods').insert({
    'mood': mood,
    'main_theme': mainTheme,
    'note': note,
    'user_id': supabase.auth.currentUser?.id,
  });
}
```
Handle errors with try/catch and show user-friendly messages.

## Realtime (Optional)
Subscribe to announcements or chat updates:
```dart
final channel = supabase.channel('public:announcements')
  .on(PostgresChangeEvent.insert, (payload) {
    // refresh UI
  })
  .subscribe();
```
Unsubscribe in `dispose`: `channel.unsubscribe();`

## Storage (Optional)
1) Create a bucket (e.g., `attachments` or `audio`).
2) Set public/private based on need; for private, add RLS storage policies (Storage > Policies) so users can only read their own files.
3) Upload from Flutter:
```dart
final bytes = await XFile(path).readAsBytes();
await supabase.storage.from('attachments').uploadBinary('user/${supabase.auth.currentUser!.id}/file.pdf', bytes);
```
4) Get signed URL for private files: `createSignedUrl(path, expiresIn: 3600)`.

## Running Supabase Locally (optional)
```
supabase init          # creates supabase/config.toml
supabase start         # runs Postgres + API locally
supabase db reset      # applies migrations
supabase stop
```
Use this if you want offline development; update your Dart defines to point to the local URL.

## Production Checklist
- Separate dev/prod projects and keys; never reuse service role in mobile apps.
- Confirm Site URL and email redirect in **Authentication > URL Configuration**.
- Enable Captcha or rate limits if you open signup to the public.
- Back up SQL ("Download as .sql") after schema changes.
- If you serve announcements via service role, restrict who can trigger writes (e.g., CLI script with env vars).

## Common Issues
- **401/permission errors**: RLS missing or keys wrong; ensure anon key is used in app and policies allow select/insert.
- **Stuck signup**: user must confirm email; resend confirmation from Auth > Users.
- **CORS** (web build): add your web origin under **Authentication > Allowed Redirect URLs** and **Auth Settings > Additional Redirect URLs**.
- **Realtime not firing**: check you subscribed to `public:table` channel and RLS allows `realtime` role to read.

This guide should let new contributors get Supabase running quickly for CalmCampus. Keep keys out of git and update task.md if you add new Supabase-dependent features.
